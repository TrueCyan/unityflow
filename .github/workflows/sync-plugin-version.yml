name: Sync Plugin Version to Marketplace

on:
  release:
    types: [published]

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout claude-plugins
        uses: actions/checkout@v4
        with:
          repository: TrueCyan/claude-plugins
          token: ${{ secrets.CLAUDE_PLUGINS_PAT }}

      - name: Update version in marketplace.json
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          VERSION="${VERSION#v}"
          jq --arg v "$VERSION" '.plugins[] |= if .name == "unityflow" then .version = $v else . end' \
            .claude-plugin/marketplace.json > tmp.json
          mv tmp.json .claude-plugin/marketplace.json

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .claude-plugin/marketplace.json
          git diff --staged --quiet || git commit -m "chore: sync unityflow version to ${{ github.event.release.tag_name }}"
          git push
